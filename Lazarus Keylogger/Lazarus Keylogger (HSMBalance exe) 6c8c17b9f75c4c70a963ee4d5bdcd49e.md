# Lazarus Keylogger (HSMBalance.exe)

# **분 석**

---

MD5 34404a3fb9804977c6ab86cb991fb130

SHA256 : c6930e298bba86c01d0fe2c8262c46b4fce97c6c5037a193904cfc634246fbec

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled.png)

위 사진은 **WinMain 코드**이다.

생각보다 많은 기능이 존재하지 않는것 같고, **sub_5B1370()**만 분석하면 끝날 것 같다.

먼저

sub5b1370()함수 전체흐름을 보겠습니다.

![https://blog.kakaocdn.net/dn/ErhGn/btqY2r7b93h/CfLM7omktH2KUkSNebskO1/img.png](https://blog.kakaocdn.net/dn/ErhGn/btqY2r7b93h/CfLM7omktH2KUkSNebskO1/img.png)

sub_5B1370() (1/2)

Temp 폴더에 Downloads라는 폴더를 하나 생성을합니다.

**[중요]** 뒤에 나오겠지만, 이 경로에 키로깅 정보가 저장됩니다.

그리고 스레드 3개정도를 만들어 주는데, 이 쓰레드들이 핵심 기능을 합니다.!

이후

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%201.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%201.png)

sub_5B1370() (2/2)

**[중요]** '**C:\Windows\Temp\TMP0389A.tmp**' 경로에 특정파일이 생성됩니다.

이 파일에는 Temp/Downloads의 절대경로가 하드코딩 되어있습니다.

**아래 사진 참고!**

*(뭐,,,, 키로깅 행위를하는데 있어서 중요한 역활을 하지 않는것으로 보입니다.)*

![https://blog.kakaocdn.net/dn/c8nsSc/btqY8Gvqf2k/MQPAobed56wDGcefZ1hVck/img.png](https://blog.kakaocdn.net/dn/c8nsSc/btqY8Gvqf2k/MQPAobed56wDGcefZ1hVck/img.png)

C:\Windows\Temp\TMP0389A.tmp

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%202.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%202.png)

이제 위 사진에 있는  3개의 함수를 순차적으로 분석 해보겠습니다.

### **StartAddress()**

---

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%203.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%203.png)

KeyLogging Routine

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%204.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%204.png)

키로깅 정보를 들고 **sub_5b1a00()**함수로 들어가게 됩니다.

![https://blog.kakaocdn.net/dn/seDn6/btqY8GWQajU/rgUabJATfK3YiAIIEPMu1k/img.png](https://blog.kakaocdn.net/dn/seDn6/btqY8GWQajU/rgUabJATfK3YiAIIEPMu1k/img.png)

sub_5b1a00() 내부

키로깅 정보가  **'..../temp/Downloads/'**에 저장되게 됩니다.

하지만 평문으로 저장되는것이 아닌!!!

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%205.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%205.png)

Keylogging info encrypt

**[중요]** xor을 거친후에 저장됩니다. 이 부분을 패치하여 평문으로 저장시켜 보았습니다.

그 결과는 아래의 이미지 입니다.

![https://blog.kakaocdn.net/dn/oc4jQ/btqY2tX007w/tAFv2Z0LpYWM75h0TlyjK1/img.png](https://blog.kakaocdn.net/dn/oc4jQ/btqY2tX007w/tAFv2Z0LpYWM75h0TlyjK1/img.png)

평문으로 저장된 결과

**[중요]** '날짜, 시간, 키, Windows 최상위 창의 title'가 로깅되는 것을 알 수 있습니다.

**또한**

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%206.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%206.png)

**[중요]** CTRL+V를 눌렀을때 클립보드의 내용도 로깅합니다!

### **sub_5B2710**

---

이 함수는 화면 캡쳐기능을 포함하고 있습니다.

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%207.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%207.png)

먼저 위와 같은 파일형식으로 '%temp%\Downloads'에 저장되는데...

**'tmp_[사용자명]_년도월_시간'** 형식을 가집니다.

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%208.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%208.png)

Screen Capture (1/2)

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%209.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%209.png)

Screen Capture (2/2)

사실 이 함수에 있는 API들이 직관적으로 와닿지 않아 API들에 대해 검색을 해보았습니다.

**[중요]** GetDC, GetSystemMetrics, CreateCompatibleDC, GetDIBits... 등의 API들이 **화면을 캡쳐할때 사용**되는 것을 알 수 있었습니다.

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%2010.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%2010.png)

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%2011.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%2011.png)

화면을 캡쳐한후 위와 같이 저장이 되는데..

![Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%2012.png](Lazarus%20Keylogger%20(HSMBalance%20exe)%206c8c17b9f75c4c70a963ee4d5bdcd49e/Untitled%2012.png)

HxD.exe

**[중요]** 앞에 8바이트는 시간 정보를 써주고 뒤에 압축파일로 저장이 됩니다.

그래서 시간 정보를 지우고 파일을 열어 보았습니다.

![https://blog.kakaocdn.net/dn/soVoo/btqZefxbc7k/rhAL6hlDPIu2d045QMJa10/img.png](https://blog.kakaocdn.net/dn/soVoo/btqZefxbc7k/rhAL6hlDPIu2d045QMJa10/img.png)

뭔가 알 수 없는 파일 형태였습니다....

( 분명 화면 캡쳐 정보가 맞긴한데.. 어떻게 이걸 볼 수 있을까요.. )

i dont know..

### **sub_5B17C0**

---

![https://blog.kakaocdn.net/dn/FwK81/btqYZ6CfVBu/7A48MW35lkVo9PMEFs7tjk/img.png](https://blog.kakaocdn.net/dn/FwK81/btqYZ6CfVBu/7A48MW35lkVo9PMEFs7tjk/img.png)

sub_5B17C0

사실 이 쓰레드의 기능은 도저히 이해를 할 수 없습니다.

![https://blog.kakaocdn.net/dn/o7lJo/btqZdkyJtu9/fpYS11SehU9TmOOZg0khJK/img.png](https://blog.kakaocdn.net/dn/o7lJo/btqZdkyJtu9/fpYS11SehU9TmOOZg0khJK/img.png)

Procmon.exe

**[중요]** 'c:\windows\temp\tmp1105.tmp' 파일이 있으면 무한루프로 빠집니다.

만약 이 파일을지우게 되면 다시 정상적으로 돌아가고...

이 함수는 그냥 넘겨도 될 부분 같습니다.!

### **결 론**

---

**키로깅(+클립보드), 화면캡쳐기능을 가지고 있다...**